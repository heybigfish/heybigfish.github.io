---
title: JavaScript-事件(任务)循环
date: 2021-08-30 18:02:07
tags: 基础
categories: JavaScript
---

##### 任务类型

`JavaScript` 是单线程语言，执行过程中会产生 2 种任务，分别是 **同步任务** 和 **异步任务**

- 同步任务：读取后立即执行，以从上到下的顺序进行执行，会阻塞线程。（同时成功、同时失败）。
- 异步任务：读取后通过任务队列（先进先出）的机制进行协调执行。

##### 任务队列

任务队列分为 **微任务** 和 **宏任务**。

- 微任务：`Promise`,`process.nextTick(Node.js)`、`MutaionObserver`。
- 宏任务： `script`(JS 整体代码块)，`setTimeout`、`setInterval`、`setImmediate`、I/O、UI 交互

##### 事件循环

任务队列的执行过程：
执行过程中如果产生异步任务（微任务、宏任务），就将他们放到各自对应任务队列（微任务队列和宏任务队列）

- 先执行一个**宏任务**。
- 当前宏任务执行完毕之后，开始执行微任务队列。
- 当前微任务队列清空之后，继续执行下一个宏任务，如此循环。

以上不断重复的过程就叫做事件循环（Event Loop）,每一次循环都被称为 **tick**

> `new Promise(...)`中的代码，也是同步代码，会立即执行。只有 then 之后的代码，才是异步执行的代码，是一个微任务。

```js
console.log("同步任务01");

setTimeout(function () {
  console.log("宏任务01");
}, 10);

new Promise((resolve) => {
  console.log("同步任务02");
  resolve();
  setTimeout(() => console.log("宏任务02"), 10);
}).then(function () {
  console.log("微任务01");
});

console.log("同步任务03");
```

**步骤解析：**

- 当前任务队列：
  微任务[]
  宏任务 [`<script>`]

  - 宏任务：

  1.  输出：`同步任务01`
  2.  遇到 `宏任务01`，加入宏任务
  3.  遇到 `Promise`，输出 `同步任务02`，直接 `resolve`，遇到 `宏任务02`，加入宏任务,遇到 `微任务01` 加入微任务。
  4.  输出 `同步任务03`。
  5.  第一个宏任务执行完毕。

- 当前任务队列：
  微任务 [`微任务 01`]
  宏任务 [`宏任务 01`，`宏任务 02`]

  - 微任务
    1. 执行微任务，输出`微任务 01`。
    2. 微任务队列清空完毕。

- 当前任务队列：
  微任务 []
  宏任务 [`宏任务 01`，`宏任务 02`]

  - 宏任务
    1. 输出`宏任务 01`
    2. 当前宏任务执行完毕。

- 当前任务队列：
  微任务 []
  宏任务 [`宏任务 02`]

  - 宏任务
    1. 输出`宏任务 02`
    2. 当前宏任务执行完毕。

> 同步任务 01 =>同步任务 02=>同步任务 03=>微任务 01=>宏任务 01=>宏任务 02

`JavaScript` 是一门单线程语言，异步操作都是放到事件循环队列里面，等待主执行栈来执行的，并没有专门的异步执行线程
